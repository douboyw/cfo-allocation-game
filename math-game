import React, { useState, useEffect } from 'react';
import { Trophy, Star, Zap, Award } from 'lucide-react';

const MathGame = () => {
  const [gameState, setGameState] = useState('menu'); // menu, playing, levelUp
  const [score, setScore] = useState(0);
  const [level, setLevel] = useState(1);
  const [streak, setStreak] = useState(0);
  const [question, setQuestion] = useState(null);
  const [userAnswer, setUserAnswer] = useState('');
  const [feedback, setFeedback] = useState('');
  const [totalCorrect, setTotalCorrect] = useState(0);
  const [totalQuestions, setTotalQuestions] = useState(0);
  const [badges, setBadges] = useState([]);

  const questionTypes = [
    'arithmetic', 'algebra', 'geometry', 'exponents', 'fractions'
  ];

  const generateQuestion = (currentLevel) => {
    const difficulty = Math.min(currentLevel, 10);
    const type = questionTypes[Math.floor(Math.random() * questionTypes.length)];
    
    let q, a;
    
    switch(type) {
      case 'arithmetic':
        const ops = ['+', '-', '*', '/'];
        const op = ops[Math.floor(Math.random() * ops.length)];
        const max = 10 + (difficulty * 5);
        let num1 = Math.floor(Math.random() * max) + 1;
        let num2 = Math.floor(Math.random() * max) + 1;
        
        if (op === '/') {
          num1 = num2 * (Math.floor(Math.random() * 10) + 1);
          a = num1 / num2;
          q = `${num1} ${op} ${num2}`;
        } else if (op === '*') {
          a = num1 * num2;
          q = `${num1} ${op} ${num2}`;
        } else if (op === '+') {
          a = num1 + num2;
          q = `${num1} ${op} ${num2}`;
        } else {
          if (num1 < num2) [num1, num2] = [num2, num1];
          a = num1 - num2;
          q = `${num1} ${op} ${num2}`;
        }
        break;
        
      case 'algebra':
        const x = Math.floor(Math.random() * 20) + 1;
        const coef = Math.floor(Math.random() * 10) + 2;
        const constant = Math.floor(Math.random() * 30) + 1;
        const result = coef * x + constant;
        q = `Solve for x: ${coef}x + ${constant} = ${result}`;
        a = x;
        break;
        
      case 'geometry':
        const side = Math.floor(Math.random() * 15) + 3;
        if (Math.random() > 0.5) {
          q = `What is the area of a square with side ${side}?`;
          a = side * side;
        } else {
          const width = Math.floor(Math.random() * 12) + 2;
          const height = Math.floor(Math.random() * 12) + 2;
          q = `What is the area of a rectangle ${width} √ó ${height}?`;
          a = width * height;
        }
        break;
        
      case 'exponents':
        const base = Math.floor(Math.random() * 8) + 2;
        const exp = Math.floor(Math.random() * 4) + 2;
        q = `What is ${base}^${exp}?`;
        a = Math.pow(base, exp);
        break;
        
      case 'fractions':
        const numerator = Math.floor(Math.random() * 10) + 1;
        const denominator = Math.floor(Math.random() * 10) + 2;
        if (Math.random() > 0.5) {
          q = `Convert ${numerator}/${denominator} to decimal (round to 2 places)`;
          a = Math.round((numerator / denominator) * 100) / 100;
        } else {
          const whole = Math.floor(Math.random() * 5) + 1;
          q = `What is ${whole} √ó ${numerator}/${denominator}? (as decimal, round to 2 places)`;
          a = Math.round((whole * numerator / denominator) * 100) / 100;
        }
        break;
    }
    
    return { question: q, answer: a, type };
  };

  const startGame = () => {
    setGameState('playing');
    setQuestion(generateQuestion(level));
    setUserAnswer('');
    setFeedback('');
  };

  const checkBadges = (correct, total, currentStreak, currentLevel) => {
    const newBadges = [...badges];
    
    if (currentStreak === 5 && !badges.includes('Hot Streak')) {
      newBadges.push('Hot Streak');
    }
    if (currentStreak === 10 && !badges.includes('Unstoppable')) {
      newBadges.push('Unstoppable');
    }
    if (correct === 10 && !badges.includes('First Ten')) {
      newBadges.push('First Ten');
    }
    if (correct === 50 && !badges.includes('Half Century')) {
      newBadges.push('Half Century');
    }
    if (currentLevel === 5 && !badges.includes('Level 5 Master')) {
      newBadges.push('Level 5 Master');
    }
    if (currentLevel === 10 && !badges.includes('Math Legend')) {
      newBadges.push('Math Legend');
    }
    
    if (newBadges.length > badges.length) {
      setBadges(newBadges);
    }
  };

  const submitAnswer = () => {
    const correct = parseFloat(userAnswer) === question.answer;
    const newTotal = totalQuestions + 1;
    setTotalQuestions(newTotal);
    
    if (correct) {
      const newCorrect = totalCorrect + 1;
      const newStreak = streak + 1;
      const points = 10 * level + (newStreak > 3 ? newStreak * 5 : 0);
      
      setScore(score + points);
      setTotalCorrect(newCorrect);
      setStreak(newStreak);
      setFeedback(`üéâ Correct! +${points} points`);
      
      // Check for level up (every 5 correct answers)
      if (newCorrect % 5 === 0) {
        const newLevel = level + 1;
        setLevel(newLevel);
        checkBadges(newCorrect, newTotal, newStreak, newLevel);
        setGameState('levelUp');
      } else {
        checkBadges(newCorrect, newTotal, newStreak, level);
        setTimeout(() => {
          setQuestion(generateQuestion(level));
          setUserAnswer('');
          setFeedback('');
        }, 1500);
      }
    } else {
      setStreak(0);
      setFeedback(`‚ùå Not quite. The answer was ${question.answer}`);
      setTimeout(() => {
        setQuestion(generateQuestion(Math.max(1, level - 1)));
        setUserAnswer('');
        setFeedback('');
      }, 2000);
    }
  };

  const continueAfterLevelUp = () => {
    setGameState('playing');
    setQuestion(generateQuestion(level));
    setUserAnswer('');
    setFeedback('');
  };

  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && userAnswer && gameState === 'playing') {
      submitAnswer();
    }
  };

  if (gameState === 'menu') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-purple-600 via-blue-600 to-cyan-500 flex items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
          <div className="mb-6">
            <Zap className="w-20 h-20 mx-auto text-yellow-500 mb-4" />
            <h1 className="text-4xl font-bold text-gray-800 mb-2">Math Challenge</h1>
            <p className="text-gray-600">Test your skills and level up!</p>
          </div>
          
          <div className="bg-gradient-to-r from-purple-100 to-blue-100 rounded-xl p-6 mb-6">
            <h2 className="text-lg font-semibold text-gray-700 mb-3">How to Play</h2>
            <ul className="text-sm text-gray-600 space-y-2 text-left">
              <li>‚Ä¢ Answer math questions correctly to score points</li>
              <li>‚Ä¢ Build streaks for bonus points</li>
              <li>‚Ä¢ Level up every 5 correct answers</li>
              <li>‚Ä¢ Unlock badges as you progress</li>
              <li>‚Ä¢ Questions adapt to your level</li>
            </ul>
          </div>
          
          <button
            onClick={startGame}
            className="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-4 rounded-xl hover:from-purple-700 hover:to-blue-700 transition-all transform hover:scale-105 shadow-lg"
          >
            Start Playing
          </button>
        </div>
      </div>
    );
  }

  if (gameState === 'levelUp') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-yellow-400 via-orange-500 to-red-500 flex items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
          <Trophy className="w-24 h-24 mx-auto text-yellow-500 mb-4 animate-bounce" />
          <h1 className="text-5xl font-bold text-gray-800 mb-2">Level {level}!</h1>
          <p className="text-xl text-gray-600 mb-6">You're getting stronger! üí™</p>
          
          <div className="bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl p-6 mb-6">
            <div className="grid grid-cols-2 gap-4 text-center">
              <div>
                <div className="text-3xl font-bold text-orange-600">{score}</div>
                <div className="text-sm text-gray-600">Total Score</div>
              </div>
              <div>
                <div className="text-3xl font-bold text-purple-600">{streak}</div>
                <div className="text-sm text-gray-600">Streak</div>
              </div>
            </div>
          </div>
          
          {badges.length > 0 && (
            <div className="mb-6">
              <h3 className="text-sm font-semibold text-gray-700 mb-2">Badges Earned</h3>
              <div className="flex flex-wrap gap-2 justify-center">
                {badges.map((badge, idx) => (
                  <span key={idx} className="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-xs font-medium">
                    üèÜ {badge}
                  </span>
                ))}
              </div>
            </div>
          )}
          
          <button
            onClick={continueAfterLevelUp}
            className="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all transform hover:scale-105 shadow-lg"
          >
            Continue
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-500 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-full">
        {/* Header Stats */}
        <div className="grid grid-cols-4 gap-4 mb-8">
          <div className="bg-blue-100 rounded-xl p-3 text-center">
            <Star className="w-6 h-6 mx-auto text-blue-600 mb-1" />
            <div className="text-2xl font-bold text-blue-600">{level}</div>
            <div className="text-xs text-gray-600">Level</div>
          </div>
          <div className="bg-green-100 rounded-xl p-3 text-center">
            <Trophy className="w-6 h-6 mx-auto text-green-600 mb-1" />
            <div className="text-2xl font-bold text-green-600">{score}</div>
            <div className="text-xs text-gray-600">Score</div>
          </div>
          <div className="bg-orange-100 rounded-xl p-3 text-center">
            <Zap className="w-6 h-6 mx-auto text-orange-600 mb-1" />
            <div className="text-2xl font-bold text-orange-600">{streak}</div>
            <div className="text-xs text-gray-600">Streak</div>
          </div>
          <div className="bg-purple-100 rounded-xl p-3 text-center">
            <Award className="w-6 h-6 mx-auto text-purple-600 mb-1" />
            <div className="text-2xl font-bold text-purple-600">{totalCorrect}/{totalQuestions}</div>
            <div className="text-xs text-gray-600">Correct</div>
          </div>
        </div>

        {/* Question */}
        <div className="bg-gradient-to-r from-indigo-100 to-purple-100 rounded-2xl p-8 mb-6">
          <div className="text-sm font-semibold text-purple-600 mb-2 uppercase tracking-wide">
            {question?.type}
          </div>
          <div className="text-3xl font-bold text-gray-800 mb-6">
            {question?.question}
          </div>
          
          <input
            type="number"
            step="0.01"
            value={userAnswer}
            onChange={(e) => setUserAnswer(e.target.value)}
            onKeyPress={handleKeyPress}
            placeholder="Enter your answer"
            disabled={feedback !== ''}
            className="w-full px-6 py-4 text-2xl border-3 border-purple-300 rounded-xl focus:outline-none focus:ring-4 focus:ring-purple-400 disabled:bg-gray-100"
          />
        </div>

        {/* Feedback */}
        {feedback && (
          <div className={`text-center text-xl font-bold mb-6 py-3 rounded-xl ${
            feedback.includes('Correct') 
              ? 'bg-green-100 text-green-700' 
              : 'bg-red-100 text-red-700'
          }`}>
            {feedback}
          </div>
        )}

        {/* Submit Button */}
        <button
          onClick={submitAnswer}
          disabled={!userAnswer || feedback !== ''}
          className="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-4 rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
        >
          Submit Answer
        </button>

        {/* Progress to next level */}
        <div className="mt-6 bg-gray-100 rounded-xl p-4">
          <div className="flex justify-between text-sm text-gray-600 mb-2">
            <span>Progress to Level {level + 1}</span>
            <span>{totalCorrect % 5}/5</span>
          </div>
          <div className="w-full bg-gray-300 rounded-full h-3">
            <div 
              className="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-500"
              style={{ width: `${(totalCorrect % 5) * 20}%` }}
            />
          </div>
        </div>
      </div>
    </div>
  );
};

export default MathGame;
